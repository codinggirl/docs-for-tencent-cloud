### 为 Topic 配置 ACL 策略后为何导致其他产品联动能力失效？

默认情况下，Topic 是没有配置 ACL 的，在同一个 VPC 内是可以自由访问该 Topic。如果需要在 VPC 内做权限控制，可以参考 [配置 ACL 策略](https://cloud.tencent.com/document/product/597/31528) 配置 ACL。

当为 Topic 添加一条 ACL 策略后，该策略会阻止其他所有不符合条件的请求访问 Topic，包括其他云产品联动 CKafka 的调用（例如：日志服务 CLS 的日志投递、云函数 SCF 消息转储、大数据 EMR 组件的消费等）。

从业务的角度来看，一旦业务为了保证设置了 ACL 后，就是不想要有不符合要求的客户端访问 Kafka 的数据，所以这个被拒绝也是合理的。

所以在为某个 Topic 增加了一条 ACL 策略前，一定要通过业务信息或者控制台的监控信息判断 Topic 是否在其他场景中使用，否则很可能导致其他联动功能出现问题。

针对此类情况，如果您一定需要做 ACL 策略管理，建议您生产消息到一个新的 Topic 来做权限分配，不要复用原有 Topic。

### 如何选取 CKafka 副本数？

建议您创建 Topic 时选择2副本或3副本存储数据，保障数据可靠性。默认创建的 Topic 是2副本，如果业务需要更高的可用性，则可以指定选择3副本运行。如果 Topic 需要更多的副本数，可以 [提交工单](https://console.cloud.tencent.com/workorder/category) 进行处理。新建 Topic 时副本选择方式如下图所示。

![topic](https://main.qcloudimg.com/raw/05f7dc495a90da08c2b1a5593b908c1f.png)

为了提高数据的安全性，当前 CKafka 已经禁止单副本 Topic 的创建，如您账户下有单副本的 Topic，建议按如下步骤迁移：
1. 创建新的 Topic，选择相同的分区，选取双副本。
2. 生产消息到新的 Topic 中，存量的单副本 Topic 继续被消费。
3. 消费完毕后修改消费者配置，订阅新的 Topic 进行消费。

### 为什么设置了 Topic 消息保留的时间，在其设置的时间点之后仍然可以查询到消息？

1. 消息中增加了一个时间戳字段和时间戳类型。目前支持的时间戳类型有两种：CreateTime 和 LogAppendTime 前者表示生产者创建这条消息的时间； 后者表示broker接收到这条消息的时间。如果客户端生产消息时间的时间戳数据不合法，会影响 broker 服务端删除数据。
2. 主题中分区数过多，消息数据过少，且分区内只存在一个日志段文件，则不会删除消息。
3. 日志删除任务会检查当前日志的大小是否超过设定的阈值, 即每个分段1GB大小。若日志段中最大的时间戳数据在保留的时间内则不会删除消息。

### Topic 创建失败的原因？

1. 已创建的所有Topic的分区数之和达到实例规格的分区数上限。解决方案：对Kafka实例扩容，或者删除不需要的Topic。
![](https://main.qcloudimg.com/raw/94904051a2fba64bb4d191b50abbf703.jpg)
2. Topic 删除是异步操作，下发删除指令后，系统会异步的删除该 Topic 的元数据。若在此期间创建同名 Topic，系统会提示 Topic 已经存在，届时请您稍后重试。这里需要等待1分钟左右，再进行重建操作。
3. Topic 已经存在集群当中，创建重名的 Topic 就会提示 Topic 已经存在。

### 为什么 Topic 数量（分区总数）存在限制？

Kafka 的 Topic 总数（分区总数）太多会使集群性能和稳定性下降。

因为单机可承载的分区数是有限度的，如果需要更多的分区那么就需要添加节点，需要更多的成本投入。Kafka的存储和协调机制是以分区为粒度的，分区数太多，会导致存储碎片化严重，单机层面的随机写增多，集群层面分区 Leader 切换效率降低，Controller 节点故障切换变慢等情况。导致集群整性能和稳定性下降。

### Topic 数量和分区数量有什么关系？

CKafka 以分区（partition）作为分配单位。

总分区数 = TopicA × 副本数 + TopicB × 副本数 + ...... + TopicN × 副本数。

即副本数也算在总分区个数里面，例如客户创建了1个 Topic、6个分区、2个副本，那么分区额度一共用了1 × 6 × 2 = 12个。

- 分区数：一个物理上分区的概念，一个 Topic 可以包含一个或者多个 partition。
- 副本数：partition 的副本个数，用于保障 partition 的高可用，为保障数据可靠性，当前不支持创建单副本 Topic，默认开启2副本。

